"use client";

import { useState, useEffect } from "react";
import { useSearchParams } from "next/navigation";
import Header from "@/components/Header";
import Footer from "@/components/Footer";
import Link from "next/link";
import { useTranslations, useLocale } from "next-intl";

// Only active calculators
const calculatorSlugs = [
  // Finance (6)
  { key: "compoundInterest", slug: "compound-interest-calculator", category: "finance" },
  { key: "mortgage", slug: "mortgage-calculator", category: "finance" },
  { key: "loan", slug: "loan-calculator", category: "finance" },
  { key: "autoLoan", slug: "auto-loan-calculator", category: "finance" },
  { key: "retirement", slug: "retirement-calculator", category: "finance" },
  { key: "savings", slug: "savings-calculator", category: "finance" },
  { key: "creditCard", slug: "credit-card-payoff-calculator", category: "finance" },
  
  // Health (2)
  { key: "bmi", slug: "bmi-calculator", category: "health" },
  { key: "calorie", slug: "calorie-calculator", category: "health" },
];

// Popular calculators (by key)
const popularKeys = ["compoundInterest", "mortgage", "bmi", "calorie", "loan"];

export default function CalculatorsPage() {
  const searchParams = useSearchParams();
  const [searchQuery, setSearchQuery] = useState("");
  const [activeCategory, setActiveCategory] = useState("all");
  const t = useTranslations("calculatorsPage");
  const locale = useLocale();

  // Get search param from URL
  useEffect(() => {
    const search = searchParams.get("search");
    if (search) {
      setSearchQuery(search);
    }
  }, [searchParams]);

  // Get translated calculator data
  const getCalculatorData = (key: string) => {
    return {
      name: t(`calcs.${key}.name`),
      desc: t(`calcs.${key}.desc`)
    };
  };

  // Filter calculators based on search and category
  const filteredCalculators = calculatorSlugs.filter((calc) => {
    const data = getCalculatorData(calc.key);
    const matchesSearch = searchQuery === "" || 
      data.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      data.desc.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = activeCategory === "all" || calc.category === activeCategory;
    return matchesSearch && matchesCategory;
  });

  const financeCalcs = filteredCalculators.filter(c => c.category === "finance");
  const healthCalcs = filteredCalculators.filter(c => c.category === "health");

  return (
    <>
      <Header />
      
      <main className="pt-20 pb-16 min-h-screen bg-slate-50">
        <div className="container">
          <div className="flex flex-col md:flex-row gap-8">
            
            {/* Sidebar */}
            <aside className="w-full md:w-64 shrink-0">
              <div className="bg-white rounded-xl p-5 shadow-sm sticky top-24">
                {/* Search */}
                <div className="mb-6">
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder={t("search")}
                    className="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none text-sm"
                  />
                </div>

                {/* Categories */}
                <div className="mb-6">
                  <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">{t("categories")}</h3>
                  <ul className="space-y-1">
                    <li>
                      <button
                        onClick={() => setActiveCategory("all")}
                        className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                          activeCategory === "all" ? "bg-blue-50 text-blue-600" : "text-slate-600 hover:bg-slate-50"
                        }`}
                      >
                        {t("allCalculators")}
                        <span className="float-right text-slate-400">{calculatorSlugs.length}</span>
                      </button>
                    </li>
                    <li>
                      <button
                        onClick={() => setActiveCategory("finance")}
                        className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                          activeCategory === "finance" ? "bg-blue-50 text-blue-600" : "text-slate-600 hover:bg-slate-50"
                        }`}
                      >
                        {t("finance")}
                        <span className="float-right text-slate-400">15</span>
                      </button>
                    </li>
                    <li>
                      <button
                        onClick={() => setActiveCategory("health")}
                        className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                          activeCategory === "health" ? "bg-blue-50 text-blue-600" : "text-slate-600 hover:bg-slate-50"
                        }`}
                      >
                        {t("healthFitness")}
                        <span className="float-right text-slate-400">10</span>
                      </button>
                    </li>
                  </ul>
                </div>

                {/* Popular */}
                <div>
                  <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">{t("popular")}</h3>
                  <ul className="space-y-1">
                    {popularKeys.map((key) => {
                      const calc = calculatorSlugs.find(c => c.key === key);
                      if (!calc) return null;
                      const data = getCalculatorData(key);
                      return (
                        <li key={key}>
                          <Link
                            href={`/${locale}/${calc.slug}`}
                            className="flex items-center gap-2 px-3 py-2 text-sm text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition-colors"
                          >
                            <span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                            {data.name}
                          </Link>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </div>
            </aside>

            {/* Main Content */}
            <div className="flex-1">
              {/* Finance Section */}
              {financeCalcs.length > 0 && (
                <section className="mb-10">
                  <h2 className="flex items-center gap-2 text-lg font-bold text-slate-900 mb-4">
                    <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                    {t("financeTitle")}
                    <span className="text-slate-400 font-normal text-sm">({financeCalcs.length})</span>
                  </h2>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {financeCalcs.map((calc) => {
                      const data = getCalculatorData(calc.key);
                      return (
                        <Link
                          key={calc.slug}
                          href={`/${locale}/${calc.slug}`}
                          className="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100"
                        >
                          <h3 className="font-semibold text-slate-900 mb-1">{data.name}</h3>
                          <p className="text-sm text-slate-500">{data.desc}</p>
                        </Link>
                      );
                    })}
                  </div>
                </section>
              )}

              {/* Health Section */}
              {healthCalcs.length > 0 && (
                <section>
                  <h2 className="flex items-center gap-2 text-lg font-bold text-slate-900 mb-4">
                    <span className="w-2 h-2 rounded-full bg-green-500"></span>
                    {t("healthTitle")}
                    <span className="text-slate-400 font-normal text-sm">({healthCalcs.length})</span>
                  </h2>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {healthCalcs.map((calc) => {
                      const data = getCalculatorData(calc.key);
                      return (
                        <Link
                          key={calc.slug}
                          href={`/${locale}/${calc.slug}`}
                          className="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100"
                        >
                          <h3 className="font-semibold text-slate-900 mb-1">{data.name}</h3>
                          <p className="text-sm text-slate-500">{data.desc}</p>
                        </Link>
                      );
                    })}
                  </div>
                </section>
              )}

              {/* No results */}
              {filteredCalculators.length === 0 && (
                <div className="text-center py-16">
                  <p className="text-slate-500">No calculators found matching your search.</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>

      <Footer />
    </>
  );
}
