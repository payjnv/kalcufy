"use client";

/**
 * MOBILE RESULTS BAR V4 â€” Redesigned
 *
 * Enhanced bottom sheet with:
 * - Gauge zones (health calculators)
 * - Composition bar (fat/lean, principal/interest)
 * - Context badges per result
 * - Insight card with human text ğŸ’¡
 * - Spring animation + drag to dismiss
 * - Fully translatable via t()
 * - Backwards compatible (no zones = classic grid)
 *
 * FIX: Removed isCurrencyField auto-detection
 * Now uses results.formatted first, then config.format
 */

import { useState, useRef, useEffect } from "react";
import type { ResultConfig, TranslationFn } from "@/engine/v4/types/engine.types";
import { useCurrency } from "@/lib/currency-helper";
import { translateText } from "@/engine/v4/utils/common-translations";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TYPES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

interface Zone {
  start: number;
  end: number;
  label: string;
  color: string;
}

interface CompositionSegment {
  label: string;
  value: number;
  color: string;
  detail?: string;
}

interface CalculatorResults {
  values: Record<string, unknown>;
  formatted: Record<string, string>;
  summary?: string;
  isValid?: boolean;
  zones?: Zone[];
  gaugeValue?: number;
  gaugeMin?: number;
  gaugeMax?: number;
  composition?: CompositionSegment[];
  insight?: string;
  context?: Record<string, { label: string; color: string }>;
  metrics?: Array<{ icon: string; id: string; context?: string }>;
  metadata?: { [key: string]: unknown };
}

interface MobileResultsBarV4Props {
  results: CalculatorResults | null;
  hasCalculated: boolean;
  primaryLabel: string;
  primaryValue: string;
  primaryUnit?: string;
  t: TranslationFn;
  locale?: string;
  onSave?: () => void;
  saveStatus?: "idle" | "saving" | "saved" | "error";
  isLoggedIn?: boolean;
  resultConfigs?: ResultConfig[];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI GAUGE â€” compact for collapsed bar
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function MiniGauge({
  value,
  min,
  max,
  zones,
}: {
  value: number;
  min: number;
  max: number;
  zones: Zone[];
}) {
  const pct = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));
  const activeZone = zones.find((z) => value >= z.start && value < z.end) || zones[zones.length - 1];

  return (
    <div className="w-full h-2 rounded-full overflow-hidden bg-slate-100 relative">
      {zones.map((zone, i) => {
        const left = ((zone.start - min) / (max - min)) * 100;
        const width = ((zone.end - zone.start) / (max - min)) * 100;
        return (
          <div
            key={i}
            className="absolute top-0 h-full"
            style={{ left: `${left}%`, width: `${width}%`, backgroundColor: zone.color, opacity: 0.2 }}
          />
        );
      })}
      <div
        className="absolute top-0 left-0 h-full rounded-full transition-all duration-700 ease-out"
        style={{ width: `${pct}%`, backgroundColor: activeZone.color }}
      />
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RADIAL PROGRESS â€” SVG circle for expanded view
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function RadialProgress({
  value,
  label,
  max,
  color,
  size = 120,
}: {
  value: string;
  label: string;
  max: number;
  color: string;
  size?: number;
}) {
  const radius = (size - 14) / 2;
  const circumference = 2 * Math.PI * radius;
  const numericValue = parseFloat(value.replace(/[^0-9.-]/g, "")) || 0;
  const pct = Math.min(numericValue / max, 1);
  const offset = circumference * (1 - pct);

  return (
    <div className="relative flex-shrink-0" style={{ width: size, height: size }}>
      <svg width={size} height={size} className="-rotate-90">
        <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke="#f1f5f9" strokeWidth="7" />
        <circle
          cx={size / 2} cy={size / 2} r={radius} fill="none" stroke={color}
          strokeWidth="7" strokeLinecap="round"
          strokeDasharray={circumference} strokeDashoffset={offset}
          className="transition-all duration-1000 ease-out"
        />
      </svg>
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        <span className="text-2xl font-bold" style={{ color }}>{value}</span>
        <span className="text-[10px] text-slate-400 font-medium mt-0.5">{label}</span>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FULL GAUGE â€” for expanded view
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function FullGauge({
  value,
  min,
  max,
  zones,
  t,
}: {
  value: number;
  min: number;
  max: number;
  zones: Zone[];
  t: TranslationFn;
}) {
  const pct = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));
  const activeZone = zones.find((z) => value >= z.start && value < z.end) || zones[zones.length - 1];
  const translate = typeof t === "function" ? t : (_k: string, fb?: string) => fb || _k;

  return (
    <div className="w-full">
      <div className="relative h-3 rounded-full overflow-hidden bg-slate-100">
        {zones.map((zone, i) => {
          const left = ((zone.start - min) / (max - min)) * 100;
          const width = ((zone.end - zone.start) / (max - min)) * 100;
          return (
            <div
              key={i}
              className="absolute top-0 h-full"
              style={{ left: `${left}%`, width: `${width}%`, backgroundColor: zone.color, opacity: 0.2 }}
            />
          );
        })}
        <div
          className="absolute top-0 left-0 h-full rounded-full transition-all duration-700 ease-out"
          style={{ width: `${pct}%`, backgroundColor: activeZone.color }}
        />
        <div
          className="absolute top-1/2 w-4 h-4 rounded-full border-2 border-white shadow-md transition-all duration-700 ease-out"
          style={{
            left: `${pct}%`,
            transform: "translate(-50%, -50%)",
            backgroundColor: activeZone.color,
          }}
        />
      </div>
      <div className="flex justify-between mt-1.5">
        {zones.map((zone, i) => {
          const isActive = value >= zone.start && value < zone.end;
          return (
            <span
              key={i}
              className="text-[10px] font-medium transition-opacity"
              style={{ color: zone.color, opacity: isActive ? 1 : 0.4 }}
            >
              {translate(`values.${zone.label}`, zone.label)}
            </span>
          );
        })}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPOSITION BAR â€” compact for mobile
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function MobileCompositionBar({
  segments,
  t,
}: {
  segments: CompositionSegment[];
  t: TranslationFn;
}) {
  const total = segments.reduce((sum, s) => sum + s.value, 0);
  if (total === 0) return null;
  const translate = typeof t === "function" ? t : (_k: string, fb?: string) => fb || _k;

  return (
    <div>
      <div className="relative h-8 rounded-xl overflow-hidden flex">
        {segments.map((seg, i) => {
          const pct = (seg.value / total) * 100;
          return (
            <div
              key={i}
              className="h-full flex items-center justify-center transition-all duration-700"
              style={{ width: `${pct}%`, backgroundColor: seg.color }}
            >
              {pct > 18 && (
                <span className="text-[10px] font-bold text-white">
                  {pct.toFixed(0)}% {translate(`values.${seg.label}`, seg.label)}
                </span>
              )}
            </div>
          );
        })}
      </div>
      <div className="grid grid-cols-2 gap-2 mt-2">
        {segments.map((seg, i) => {
          const bgColors: Record<string, string> = {
            "#3b82f6": "bg-blue-50 border-blue-100",
            "#f59e0b": "bg-amber-50 border-amber-100",
            "#22c55e": "bg-emerald-50 border-emerald-100",
            "#ef4444": "bg-red-50 border-red-100",
            "#8b5cf6": "bg-violet-50 border-violet-100",
          };
          const dotColors: Record<string, string> = {
            "#3b82f6": "bg-blue-500",
            "#f59e0b": "bg-amber-500",
            "#22c55e": "bg-emerald-500",
            "#ef4444": "bg-red-500",
            "#8b5cf6": "bg-violet-500",
          };
          const textColors: Record<string, string> = {
            "#3b82f6": "text-blue-600",
            "#f59e0b": "text-amber-600",
            "#22c55e": "text-emerald-600",
            "#ef4444": "text-red-600",
            "#8b5cf6": "text-violet-600",
          };

          return (
            <div key={i} className={`rounded-xl p-2.5 border ${bgColors[seg.color] || "bg-slate-50 border-slate-100"}`}>
              <div className="flex items-center gap-1.5 mb-0.5">
                <div className={`w-1.5 h-1.5 rounded-full ${dotColors[seg.color] || "bg-slate-500"}`} />
                <span className={`text-[10px] font-medium ${textColors[seg.color] || "text-slate-600"}`}>
                  {translate(`values.${seg.label}`, seg.label)}
                </span>
              </div>
              <p className="text-lg font-bold text-slate-900">
                {seg.detail || seg.value.toLocaleString()}
              </p>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN MOBILE RESULTS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

export default function MobileResultsBarV4({
  results,
  hasCalculated,
  primaryLabel,
  primaryValue,
  primaryUnit,
  t,
  locale = "en",
  onSave,
  saveStatus = "idle",
  isLoggedIn,
  resultConfigs = [],
}: MobileResultsBarV4Props) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isDragging, setIsDragging] = useState(false);
  const [dragY, setDragY] = useState(0);
  const [shareStatus, setShareStatus] = useState<"idle" | "sharing" | "copied">("idle");
  const [contentHeight, setContentHeight] = useState(0);

  const { format: formatCurrency } = useCurrency();
  const translate = typeof t === "function" ? t : (key: string, fallback?: string) => fallback || key;

  const contentRef = useRef<HTMLDivElement>(null);
  const sheetRef = useRef<HTMLDivElement>(null);
  const startY = useRef(0);
  const currentY = useRef(0);

  const secondaryResults = resultConfigs.filter((r) => r.type === "secondary");

  // Enhanced data checks
  const hasZones = results?.zones && results.zones.length > 0 && results.gaugeValue !== undefined;
  const hasComposition = results?.composition && results.composition.length > 0;
  const hasInsight = !!results?.insight;
  const hasMetrics = results?.metrics && results.metrics.length > 0;
  const hasContext = results?.context && Object.keys(results.context).length > 0;

  // Active zone for badge
  const activeZone =
    hasZones && results!.gaugeValue !== undefined
      ? results!.zones!.find((z) => results!.gaugeValue! >= z.start && results!.gaugeValue! < z.end) ||
        results!.zones![results!.zones!.length - 1]
      : null;

  // Translate dynamic {{t:key}} patterns
  const translateDynamic = (value: unknown) => {
    if (!value || typeof value !== "string") return value || "";
    let translated = value.replace(
      /\{\{t:([^|}]+)(?:\|([^}]+))?\}\}/g,
      (_, key, fallback) => translate(key, fallback || key)
    );
    translated = translateText(translated, locale);
    return translated;
  };

  // Format value â€” uses results.formatted FIRST, then config.format
  const formatValue = (value: unknown, config: { id: string; label: string; format?: string }): string => {
    if (value === null || value === undefined) return "--";

    // PRIORITY 1: pre-formatted
    if (results?.formatted && results.formatted[config.id]) {
      return results.formatted[config.id];
    }

    // PRIORITY 2: string as-is
    if (typeof value === "string") {
      return translateDynamic(value) as string;
    }

    // PRIORITY 3: format by config
    const num = Number(value);
    if (isNaN(num)) return String(value);

    switch (config.format) {
      case "currency":
        return formatCurrency(num, { decimals: 2 });
      case "percentage":
        return `${num.toFixed(2)}%`;
      default:
        if (Math.abs(num) >= 1000) return num.toLocaleString("en-US", { maximumFractionDigits: 2 });
        return num % 1 === 0 ? String(num) : num.toFixed(2);
    }
  };

  // Measure content
  useEffect(() => {
    if (contentRef.current && isExpanded) {
      setContentHeight(contentRef.current.scrollHeight);
    }
  }, [results, secondaryResults.length, isExpanded]);

  // Lock body scroll
  useEffect(() => {
    if (isExpanded) document.body.style.overflow = "hidden";
    else document.body.style.overflow = "";
    return () => { document.body.style.overflow = ""; };
  }, [isExpanded]);

  if (!results || !hasCalculated) return null;

  // Heights
  const headerHeight = 88;
  const shareButtonHeight = 72;
  const maxExpandedHeight = typeof window !== "undefined" ? window.innerHeight * 0.85 : 700;
  const idealExpandedHeight = headerHeight + contentHeight + shareButtonHeight + 16;
  const expandedHeight = Math.min(idealExpandedHeight, maxExpandedHeight);
  const needsScroll = idealExpandedHeight > maxExpandedHeight;

  // Drag handlers
  const handleTouchStart = (e: React.TouchEvent) => {
    startY.current = e.touches[0].clientY;
    currentY.current = 0;
    setIsDragging(true);
  };
  const handleTouchMove = (e: React.TouchEvent) => {
    if (!isDragging) return;
    const deltaY = e.touches[0].clientY - startY.current;
    currentY.current = deltaY;
    if (isExpanded && deltaY > 0) setDragY(deltaY * 0.5);
    else if (!isExpanded && deltaY < 0) setDragY(deltaY * 0.3);
  };
  const handleTouchEnd = () => {
    setIsDragging(false);
    const threshold = 50;
    if (isExpanded && currentY.current > threshold) setIsExpanded(false);
    else if (!isExpanded && currentY.current < -threshold) setIsExpanded(true);
    setDragY(0);
  };

  // Share
  const handleShare = async () => {
    setShareStatus("sharing");
    let shareText = `${primaryLabel}: ${primaryValue}${primaryUnit || ""}`;
    secondaryResults.forEach((config) => {
      const fv = formatValue(results.values[config.id], config);
      if (fv && fv !== "--") shareText += `\n${config.label}: ${fv}`;
    });
    if (results.insight) shareText += `\n\n${results.insight}`;
    else if (results.summary) shareText += `\n\n${translateDynamic(results.summary)}`;
    shareText += `\n\n${translate("share.calculatedWith", "Calculated with Kalcufy.com")}`;

    const shareData = { title: primaryLabel, text: shareText, url: window.location.href };
    try {
      if (navigator.share) await navigator.share(shareData);
      else await navigator.clipboard.writeText(shareText + `\n${window.location.href}`);
      setShareStatus("copied");
    } catch {
      try {
        await navigator.clipboard.writeText(shareText + `\n${window.location.href}`);
        setShareStatus("copied");
      } catch {
        setShareStatus("idle");
      }
    }
    setTimeout(() => setShareStatus("idle"), 2000);
  };

  const getCurrentHeight = () => {
    if (isDragging) {
      const baseHeight = isExpanded ? expandedHeight : headerHeight;
      return Math.max(headerHeight, baseHeight - dragY);
    }
    return isExpanded ? expandedHeight : headerHeight;
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RENDER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  return (
    <>
      {/* Backdrop */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition-all duration-300 ease-out ${
          isExpanded ? "bg-black/40 backdrop-blur-sm pointer-events-auto" : "bg-transparent pointer-events-none"
        }`}
        onClick={() => setIsExpanded(false)}
        aria-hidden="true"
      />

      {/* Bottom Sheet */}
      <div
        ref={sheetRef}
        className={`fixed bottom-0 left-0 right-0 z-50 md:hidden bg-white rounded-t-3xl shadow-2xl ${
          isDragging ? "" : "transition-all duration-300 ease-[cubic-bezier(0.32,0.72,0,1)]"
        }`}
        style={{ height: getCurrentHeight() }}
        role="region"
        aria-label={translate("accessibility.mobileResults", "Results summary")}
      >
        {/* Drag Handle */}
        <div
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          onClick={() => setIsExpanded(!isExpanded)}
          className="w-full py-3 flex justify-center cursor-grab active:cursor-grabbing touch-none"
        >
          <div className={`w-10 h-1 rounded-full transition-all duration-200 ${isDragging ? "bg-slate-400 w-14" : "bg-slate-300"}`} />
        </div>

        {/* â”€â”€â”€ Collapsed: Primary + Zone Badge + Mini Gauge â”€â”€â”€ */}
        <div className="px-5 pb-4">
          <div className="flex items-center justify-between gap-4">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-0.5">
                <p className="text-xs text-slate-500 truncate">
                  {translate("results.primary", primaryLabel)}
                </p>
                {activeZone && (
                  <span
                    className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[10px] font-semibold flex-shrink-0"
                    style={{ backgroundColor: `${activeZone.color}15`, color: activeZone.color }}
                  >
                    {translate(`values.${activeZone.label}`, activeZone.label)}
                  </span>
                )}
              </div>
              <p className="text-2xl font-bold text-slate-900 truncate" aria-live="polite">
                {primaryValue}
                {primaryUnit && (
                  <span className="text-base font-normal text-slate-500 ml-1">{primaryUnit}</span>
                )}
              </p>
              {/* Mini gauge under primary value */}
              {hasZones && (
                <div className="mt-2">
                  <MiniGauge
                    value={results.gaugeValue!}
                    min={results.gaugeMin ?? results.zones![0].start}
                    max={results.gaugeMax ?? results.zones![results.zones!.length - 1].end}
                    zones={results.zones!}
                  />
                </div>
              )}
            </div>
            <div className="flex gap-2 flex-shrink-0">
              {isLoggedIn && onSave && (
                <button
                  onClick={onSave}
                  disabled={saveStatus === "saving"}
                  className={`w-11 h-11 flex items-center justify-center rounded-xl transition-all duration-200 active:scale-95 ${
                    saveStatus === "saved"
                      ? "bg-green-600 text-white"
                      : "bg-blue-600 text-white hover:bg-blue-700"
                  } disabled:opacity-50`}
                  aria-label={translate("buttons.saveResults", "Save results")}
                >
                  {saveStatus === "saving" ? (
                    <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                    </svg>
                  ) : saveStatus === "saved" ? (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                  )}
                </button>
              )}
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="w-11 h-11 flex items-center justify-center border border-slate-200 rounded-xl text-slate-700 hover:bg-slate-50 transition-all duration-200 active:scale-95"
                aria-label={isExpanded ? translate("buttons.hideDetails", "Hide details") : translate("buttons.showDetails", "Show details")}
              >
                <svg
                  className={`w-5 h-5 transition-transform duration-300 ${isExpanded ? "rotate-180" : ""}`}
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        {/* â”€â”€â”€ Expanded Content â”€â”€â”€ */}
        <div
          className={`flex flex-col transition-opacity duration-200 ${
            isExpanded ? "opacity-100" : "opacity-0 pointer-events-none"
          }`}
          style={{ height: isExpanded ? expandedHeight - headerHeight : 0, overflow: "hidden" }}
        >
          <div
            ref={contentRef}
            className={`flex-1 px-5 border-t border-slate-100 ${needsScroll ? "overflow-y-auto" : ""}`}
          >
            {/* Radial + Context (expanded hero) */}
            {hasZones && (
              <div className="pt-4 pb-2">
                <div className="flex items-center gap-4">
                  <RadialProgress
                    value={primaryValue}
                    label={translate("results.primary", primaryLabel)}
                    max={results.gaugeMax ?? results.zones![results.zones!.length - 1].end}
                    color={activeZone?.color || "#3b82f6"}
                    size={110}
                  />
                  <div className="flex-1 min-w-0">
                    {activeZone && (
                      <div className="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[11px] font-semibold mb-1.5"
                        style={{ backgroundColor: `${activeZone.color}15`, color: activeZone.color }}>
                        <span className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: activeZone.color }} />
                        {translate(`values.${activeZone.label}`, activeZone.label)}
                      </div>
                    )}
                    <p className="text-xs text-slate-500">
                      {translate("results.primary", primaryLabel)}
                    </p>
                  </div>
                </div>
                {/* Full gauge below radial */}
                <div className="mt-3">
                  <FullGauge
                    value={results.gaugeValue!}
                    min={results.gaugeMin ?? results.zones![0].start}
                    max={results.gaugeMax ?? results.zones![results.zones!.length - 1].end}
                    zones={results.zones!}
                    t={t}
                  />
                </div>
              </div>
            )}

            {/* Composition */}
            {hasComposition && (
              <div className="pt-3 pb-2">
                <p className="text-[10px] font-semibold text-slate-400 uppercase tracking-wider mb-2">
                  {translate("values.Composition", "Composition")}
                </p>
                <MobileCompositionBar segments={results.composition!} t={t} />
              </div>
            )}

            {/* Key Metrics (icon list) */}
            {hasMetrics && (
              <div className="pt-3 pb-2">
                <p className="text-[10px] font-semibold text-slate-400 uppercase tracking-wider mb-2">
                  {translate("values.Key Metrics", "Key Metrics")}
                </p>
                <div className="space-y-1.5">
                  {results.metrics!.map((metric) => {
                    const config = resultConfigs.find((r) => r.id === metric.id);
                    if (!config) return null;
                    const value = formatValue(results.values[config.id], config);
                    if (!value || value === "--") return null;
                    const ctx = hasContext ? results.context![metric.id] : null;

                    return (
                      <div key={metric.id} className="flex items-center gap-2.5 p-2.5 rounded-xl bg-slate-50">
                        <span className="text-base">{metric.icon}</span>
                        <div className="flex-1 min-w-0">
                          <p className="text-[10px] text-slate-500">
                            {translate(`results.${config.id}`, config.label)}
                          </p>
                          <p className="text-sm font-semibold text-slate-900">{value}</p>
                        </div>
                        {(ctx || metric.context) && (
                          <span
                            className="text-[10px] font-medium px-1.5 py-0.5 rounded-full flex-shrink-0"
                            style={
                              ctx
                                ? { backgroundColor: `${ctx.color}12`, color: ctx.color }
                                : { backgroundColor: "#f1f5f9", color: "#64748b" }
                            }
                          >
                            {ctx
                              ? translate(`values.${ctx.label}`, ctx.label)
                              : translate(`values.${metric.context}`, metric.context)}
                          </span>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Classic grid fallback (no metrics) */}
            {!hasMetrics && secondaryResults.length > 0 && (
              <div className="grid grid-cols-2 gap-3 pt-4">
                {secondaryResults.map((config) => {
                  const value = formatValue(results.values[config.id], config);
                  if (!value || value === "--" || value === "0" || value === "NaN") return null;
                  const ctx = hasContext ? results.context![config.id] : null;
                  return (
                    <div key={config.id} className="bg-slate-50 rounded-xl p-3 text-center">
                      <p className="text-[10px] text-slate-500 mb-0.5">
                        {translate(`results.${config.id}`, config.label)}
                      </p>
                      <p className="text-lg font-bold text-slate-800">{value}</p>
                      {ctx && (
                        <span
                          className="inline-block mt-0.5 text-[9px] font-medium px-1.5 py-0.5 rounded-full"
                          style={{ backgroundColor: `${ctx.color}12`, color: ctx.color }}
                        >
                          {translate(`values.${ctx.label}`, ctx.label)}
                        </span>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {/* Insight card */}
            {hasInsight && (
              <div className="pt-3 pb-2">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3.5 border border-blue-100">
                  <div className="flex gap-2.5">
                    <span className="text-lg mt-0.5 flex-shrink-0">ğŸ’¡</span>
                    <div>
                      <p className="text-xs font-semibold text-slate-900 mb-0.5">
                        {translate("values.What this means", "What this means")}
                      </p>
                      <p className="text-[11px] text-slate-600 leading-relaxed">
                        {results.insight}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Summary fallback (only if no insight) */}
            {results.summary && !hasInsight && (
              <div className="mt-3 p-3 bg-blue-50 rounded-xl">
                <p className="text-xs text-blue-800">{translateDynamic(results.summary)}</p>
              </div>
            )}
          </div>

          {/* Share Button */}
          <div className="flex-shrink-0 px-5 py-4 bg-white border-t border-slate-100">
            <button
              onClick={handleShare}
              disabled={shareStatus === "sharing"}
              className={`w-full py-3.5 flex items-center justify-center gap-2 rounded-xl font-medium transition-all duration-200 active:scale-[0.98] ${
                shareStatus === "copied"
                  ? "bg-green-50 text-green-700 border border-green-200"
                  : "bg-white border border-slate-200 text-slate-700 hover:bg-slate-50"
              } disabled:opacity-50`}
              aria-label={translate("buttons.shareResults", "Share results")}
            >
              {shareStatus === "sharing" ? (
                <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                </svg>
              ) : shareStatus === "copied" ? (
                <>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  <span>{translate("buttons.copied", "Copied!")}</span>
                </>
              ) : (
                <>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                  <span>{translate("buttons.shareResults", "Share Results")}</span>
                </>
              )}
            </button>
          </div>
        </div>
      </div>
    </>
  );
}
