// ============================================================================
// KALCUFY V4 - UNIT DROPDOWN COMPONENT
// ============================================================================
// Inline unit selector that replaces the static suffix in input fields.
// Clean, minimal design: just unit text + chevron. No flags, no emojis.
//
// Visual:  [  180  lbs ∨ ]  →  click  →  kg
//                                         lb  ✓
//                                         st
// ============================================================================

"use client";

import { useState, useRef, useEffect, useCallback } from "react";
import type { UnitDefinition } from "../units/types";

// ─────────────────────────────────────────────────────────────────────────────
// PROPS
// ─────────────────────────────────────────────────────────────────────────────

interface UnitDropdownProps {
  /** All units available for this field */
  units: UnitDefinition[];

  /** Currently selected unit ID */
  selectedUnit: string;

  /** Called when user selects a different unit */
  onUnitChange: (unitId: string) => void;

  /** Size variant */
  size?: "sm" | "md";

  /** Disabled state */
  disabled?: boolean;

  /** Accessible label */
  ariaLabel?: string;

  /** Translation function for unit names (optional) */
  t?: (key: string, fallback?: string) => string;
}

// ─────────────────────────────────────────────────────────────────────────────
// COMPONENT
// ─────────────────────────────────────────────────────────────────────────────

export default function UnitDropdown({
  units,
  selectedUnit,
  onUnitChange,
  size = "sm",
  disabled = false,
  ariaLabel,
  t,
}: UnitDropdownProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [highlightedIndex, setHighlightedIndex] = useState(-1);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const buttonRef = useRef<HTMLButtonElement>(null);
  const listRef = useRef<HTMLDivElement>(null);

  const selected = units.find((u) => u.id === selectedUnit);

  // ── Single unit or no match → static text, no dropdown ──
  if (!selected || units.length <= 1) {
    return (
      <span
        className={`shrink-0 text-slate-400 font-medium select-none ${
          size === "sm" ? "text-xs pr-3" : "text-sm pr-3"
        }`}
      >
        {selected?.symbol || selectedUnit}
      </span>
    );
  }

  // ── Close on click outside or Escape ──
  useEffect(() => {
    if (!isOpen) return;

    const handleClickOutside = (e: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(e.target as Node)
      ) {
        setIsOpen(false);
      }
    };

    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        setIsOpen(false);
        buttonRef.current?.focus();
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    document.addEventListener("keydown", handleEscape);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
      document.removeEventListener("keydown", handleEscape);
    };
  }, [isOpen]);

  // ── Reset highlight when opening ──
  useEffect(() => {
    if (isOpen) {
      const idx = units.findIndex((u) => u.id === selectedUnit);
      setHighlightedIndex(idx >= 0 ? idx : 0);
    }
  }, [isOpen, units, selectedUnit]);

  const handleSelect = useCallback(
    (unitId: string) => {
      if (unitId !== selectedUnit) {
        onUnitChange(unitId);
      }
      setIsOpen(false);
      buttonRef.current?.focus();
    },
    [selectedUnit, onUnitChange]
  );

  // ── Keyboard navigation ──
  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent) => {
      if (!isOpen) {
        if (e.key === "ArrowDown" || e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          setIsOpen(true);
        }
        return;
      }

      switch (e.key) {
        case "ArrowDown":
          e.preventDefault();
          setHighlightedIndex((prev) => (prev + 1) % units.length);
          break;
        case "ArrowUp":
          e.preventDefault();
          setHighlightedIndex(
            (prev) => (prev - 1 + units.length) % units.length
          );
          break;
        case "Enter":
        case " ":
          e.preventDefault();
          if (highlightedIndex >= 0 && highlightedIndex < units.length) {
            handleSelect(units[highlightedIndex].id);
          }
          break;
        case "Tab":
          setIsOpen(false);
          break;
      }
    },
    [isOpen, units, highlightedIndex, handleSelect]
  );

  // ── Scroll highlighted item into view ──
  useEffect(() => {
    if (!isOpen || highlightedIndex < 0 || !listRef.current) return;
    const items = listRef.current.querySelectorAll('[role="option"]');
    items[highlightedIndex]?.scrollIntoView({ block: "nearest" });
  }, [highlightedIndex, isOpen]);

  const getUnitName = (unit: UnitDefinition) => {
    if (t) return t(`units.${unit.id}.name`, unit.name);
    return unit.name;
  };

  return (
    <div
      ref={dropdownRef}
      className="relative shrink-0"
      onKeyDown={handleKeyDown}
    >
      {/* ── Trigger Button ── */}
      <button
        ref={buttonRef}
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        aria-label={ariaLabel || `Change unit: ${selected.name}`}
        aria-haspopup="listbox"
        aria-expanded={isOpen}
        className={`
          flex items-center gap-0.5 rounded-md transition-all select-none
          ${
            disabled
              ? "text-slate-300 cursor-not-allowed"
              : "text-slate-500 hover:text-blue-600 hover:bg-blue-50/60 active:bg-blue-100/50 cursor-pointer"
          }
          ${
            size === "sm"
              ? "text-xs font-medium px-1.5 py-0.5 mr-1"
              : "text-sm font-medium px-2 py-1 mr-1.5"
          }
        `}
      >
        <span>{selected.symbol}</span>
        {/* Chevron */}
        <svg
          className={`transition-transform duration-200 ${
            isOpen ? "rotate-180" : ""
          } ${size === "sm" ? "w-2.5 h-2.5 ml-0.5" : "w-3 h-3 ml-0.5"}`}
          viewBox="0 0 12 12"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          aria-hidden="true"
        >
          <path d="M3 4.5L6 7.5L9 4.5" />
        </svg>
      </button>

      {/* ── Dropdown Panel ── */}
      {isOpen && (
        <div
          ref={listRef}
          role="listbox"
          aria-label="Select unit"
          className="absolute z-50 right-0 mt-1 py-1 bg-white rounded-xl shadow-lg shadow-slate-200/60 border border-slate-200/80 min-w-[160px] max-h-[240px] overflow-y-auto"
          style={{
            animation:
              "unitDropdownIn 150ms cubic-bezier(0.16, 1, 0.3, 1) forwards",
          }}
        >
          {units.map((unit, index) => {
            const isSelected = unit.id === selectedUnit;
            const isHighlighted = index === highlightedIndex;

            return (
              <button
                key={unit.id}
                type="button"
                role="option"
                aria-selected={isSelected}
                onClick={() => handleSelect(unit.id)}
                onMouseEnter={() => setHighlightedIndex(index)}
                className={`
                  w-full flex items-center gap-2.5 px-3 py-2 text-left transition-colors
                  ${
                    isSelected
                      ? "bg-blue-50 text-blue-700"
                      : isHighlighted
                      ? "bg-slate-50 text-slate-700"
                      : "text-slate-600 hover:bg-slate-50"
                  }
                `}
              >
                {/* Symbol */}
                <span
                  className={`text-xs font-semibold min-w-[32px] ${
                    isSelected ? "text-blue-700" : "text-slate-800"
                  }`}
                >
                  {unit.symbol}
                </span>

                {/* Name */}
                <span
                  className={`text-[11px] flex-1 ${
                    isSelected ? "text-blue-500" : "text-slate-400"
                  }`}
                >
                  {getUnitName(unit)}
                </span>

                {/* Check mark */}
                {isSelected && (
                  <svg
                    className="w-3.5 h-3.5 text-blue-600 shrink-0"
                    viewBox="0 0 16 16"
                    fill="currentColor"
                  >
                    <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 111.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z" />
                  </svg>
                )}
              </button>
            );
          })}
        </div>
      )}

      {/* ── Animation keyframes ── */}
      <style jsx>{`
        @keyframes unitDropdownIn {
          from {
            opacity: 0;
            transform: translateY(-4px) scale(0.97);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `}</style>
    </div>
  );
}

// ─────────────────────────────────────────────────────────────────────────────
// CURRENCY DROPDOWN VARIANT
// ─────────────────────────────────────────────────────────────────────────────
// Shows currency code prominently: USD ∨ → dropdown with symbol + name

export function CurrencyUnitDropdown({
  currencies,
  selectedCurrency,
  onCurrencyChange,
  disabled = false,
  ariaLabel,
}: {
  currencies: Array<{
    id: string;
    code: string;
    symbol: string;
    name: string;
  }>;
  selectedCurrency: string;
  onCurrencyChange: (code: string) => void;
  disabled?: boolean;
  ariaLabel?: string;
}) {
  const [isOpen, setIsOpen] = useState(false);
  const [highlightedIndex, setHighlightedIndex] = useState(-1);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const buttonRef = useRef<HTMLButtonElement>(null);
  const listRef = useRef<HTMLDivElement>(null);

  const selected = currencies.find(
    (c) => c.id === selectedCurrency || c.code === selectedCurrency
  );

  useEffect(() => {
    if (!isOpen) return;
    const handleClickOutside = (e: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(e.target as Node)
      ) {
        setIsOpen(false);
      }
    };
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        setIsOpen(false);
        buttonRef.current?.focus();
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    document.addEventListener("keydown", handleEscape);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
      document.removeEventListener("keydown", handleEscape);
    };
  }, [isOpen]);

  useEffect(() => {
    if (isOpen) {
      const idx = currencies.findIndex(
        (c) => c.id === selectedCurrency || c.code === selectedCurrency
      );
      setHighlightedIndex(idx >= 0 ? idx : 0);
    }
  }, [isOpen, currencies, selectedCurrency]);

  if (!selected || currencies.length <= 1) {
    return (
      <span className="shrink-0 text-slate-400 text-xs font-medium pl-2 pr-3 select-none">
        {selected?.code || selectedCurrency}
      </span>
    );
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (!isOpen) {
      if (e.key === "ArrowDown" || e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        setIsOpen(true);
      }
      return;
    }
    switch (e.key) {
      case "ArrowDown":
        e.preventDefault();
        setHighlightedIndex((prev) => (prev + 1) % currencies.length);
        break;
      case "ArrowUp":
        e.preventDefault();
        setHighlightedIndex(
          (prev) => (prev - 1 + currencies.length) % currencies.length
        );
        break;
      case "Enter":
      case " ":
        e.preventDefault();
        if (
          highlightedIndex >= 0 &&
          highlightedIndex < currencies.length
        ) {
          onCurrencyChange(currencies[highlightedIndex].code);
          setIsOpen(false);
          buttonRef.current?.focus();
        }
        break;
      case "Tab":
        setIsOpen(false);
        break;
    }
  };

  return (
    <div
      ref={dropdownRef}
      className="relative shrink-0"
      onKeyDown={handleKeyDown}
    >
      <button
        ref={buttonRef}
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        aria-label={ariaLabel || `Change currency: ${selected.name}`}
        aria-haspopup="listbox"
        aria-expanded={isOpen}
        className={`
          flex items-center gap-0.5 rounded-md px-1.5 py-0.5 mr-1 transition-all select-none text-xs font-medium
          ${
            disabled
              ? "text-slate-300 cursor-not-allowed"
              : "text-slate-500 hover:text-blue-600 hover:bg-blue-50/60 active:bg-blue-100/50 cursor-pointer"
          }
        `}
      >
        <span>{selected.code}</span>
        <svg
          className={`w-2.5 h-2.5 ml-0.5 transition-transform duration-200 ${
            isOpen ? "rotate-180" : ""
          }`}
          viewBox="0 0 12 12"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
        >
          <path d="M3 4.5L6 7.5L9 4.5" />
        </svg>
      </button>

      {isOpen && (
        <div
          ref={listRef}
          role="listbox"
          className="absolute z-50 right-0 mt-1 py-1 bg-white rounded-xl shadow-lg shadow-slate-200/60 border border-slate-200/80 min-w-[200px] max-h-[280px] overflow-y-auto"
          style={{
            animation:
              "unitDropdownIn 150ms cubic-bezier(0.16, 1, 0.3, 1) forwards",
          }}
        >
          {currencies.map((cur, index) => {
            const isSelected =
              cur.id === selectedCurrency || cur.code === selectedCurrency;
            const isHighlighted = index === highlightedIndex;

            return (
              <button
                key={cur.id}
                type="button"
                role="option"
                aria-selected={isSelected}
                onClick={() => {
                  onCurrencyChange(cur.code);
                  setIsOpen(false);
                  buttonRef.current?.focus();
                }}
                onMouseEnter={() => setHighlightedIndex(index)}
                className={`
                  w-full flex items-center gap-2.5 px-3 py-2 text-left transition-colors
                  ${
                    isSelected
                      ? "bg-blue-50 text-blue-700"
                      : isHighlighted
                      ? "bg-slate-50 text-slate-700"
                      : "text-slate-600 hover:bg-slate-50"
                  }
                `}
              >
                {/* Code */}
                <span
                  className={`text-xs font-bold min-w-[36px] ${
                    isSelected ? "text-blue-700" : "text-slate-800"
                  }`}
                >
                  {cur.code}
                </span>

                {/* Symbol + Name */}
                <span className="flex-1 min-w-0 flex items-center gap-1.5">
                  <span
                    className={`text-xs ${
                      isSelected ? "text-blue-500" : "text-slate-500"
                    }`}
                  >
                    {cur.symbol}
                  </span>
                  <span
                    className={`text-[10px] truncate ${
                      isSelected ? "text-blue-400" : "text-slate-400"
                    }`}
                  >
                    {cur.name}
                  </span>
                </span>

                {/* Check */}
                {isSelected && (
                  <svg
                    className="w-3.5 h-3.5 text-blue-600 shrink-0"
                    viewBox="0 0 16 16"
                    fill="currentColor"
                  >
                    <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 111.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z" />
                  </svg>
                )}
              </button>
            );
          })}
        </div>
      )}

      <style jsx>{`
        @keyframes unitDropdownIn {
          from {
            opacity: 0;
            transform: translateY(-4px) scale(0.97);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `}</style>
    </div>
  );
}
